repos:
# Basic file hygiene (very fast)
-   repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v5.0.0
    hooks:
    -   id: trailing-whitespace
    -   id: end-of-file-fixer
    -   id: check-yaml
    -   id: check-added-large-files
        args: ['--maxkb=500']  # Stricter limit

# Security scanning (secret detection)
-   repo: https://github.com/trufflesecurity/trufflehog
    rev: v3.89.0
    hooks:
    -   id: trufflehog
        name: TruffleHog Secret Detection
        description: Detect hardcoded secrets in code
        entry: sh -c 'if command -v trufflehog >/dev/null 2>&1; then trufflehog git file://. --since-commit HEAD --only-verified --fail; else echo "⚠️  TruffleHog not installed locally - secret scanning will run in CI"; fi'
        language: system
        stages: [pre-commit]
        always_run: true

# Fast Go checks only
-   repo: https://github.com/dnephin/pre-commit-golang
    rev: v0.5.1
    hooks:
    -   id: go-fmt
    -   id: go-vet
        exclude: "(internal/e2e/.*|internal/lint/.*)"
    -   id: go-mod-tidy

# Advanced Go linting (matches CI configuration)
-   repo: local
    hooks:
    -   id: golangci-lint
        name: Run golangci-lint (Optimized)
        entry: sh -c 'if command -v golangci-lint >/dev/null 2>&1; then timeout 4m golangci-lint run --timeout=3m --fast --skip-dirs=internal/integration,internal/e2e; else echo "⚠️  golangci-lint not installed locally - linting will run in CI"; fi'
        language: system
        types: [go]
        pass_filenames: false
        description: Run fast Go linting (excludes slow integration tests, matches CI)

# Local fast checks
-   repo: local
    hooks:
    -   id: check-correlation-id
        name: Check for manual correlation_id formatting in logs
        entry: scripts/check-correlation-id.sh
        language: script
        types: [go]
        pass_filenames: false
    -   id: check-large-files
        name: Check for large Go files
        entry: scripts/check-large-files.sh
        language: script
        types: [go]
        pass_filenames: false
    -   id: check-licenses
        name: Check dependency license compliance
        entry: scripts/check-licenses.sh
        language: script
        files: ^(go\.mod|go\.sum)$
        pass_filenames: false
        description: Verify all Go dependencies use approved licenses
    -   id: validate-ci-config
        name: Validate GitHub Actions workflow configuration
        entry: scripts/validate-ci-config.sh
        language: script
        files: ^\.github/workflows/.*\.(yml|yaml)$
        pass_filenames: false
    -   id: go-build-check
        name: Go Build Verification (Fast)
        entry: sh -c 'timeout 2m go build -a ./... >/dev/null 2>&1 || { echo "❌ Build failed - fix compilation errors before committing"; exit 1; }'
        language: system
        types: [go]
        pass_filenames: false
        description: Verify code compiles successfully before commit (2min timeout)
    -   id: fast-tokenizer-tests
        name: Fast Tokenizer Performance Tests
        entry: sh -c 'timeout 1m go test -short -parallel 4 -timeout=45s ./internal/thinktank/tokenizers/... -run "TestStreamingTokenization_RespectsContextCancellation|TestOpenAITokenizer_CountTokens|TestGeminiTokenizer_CountTokens" || { echo "❌ Fast tokenizer tests failed - check for performance regressions"; exit 1; }'
        language: system
        types: [go]
        pass_filenames: false
        description: Run fast tokenizer tests to catch performance regressions early
    -   id: go-coverage-check
        name: Go Coverage Regression Check (Optimized)
        entry: timeout 8m scripts/check-coverage-fast.sh 79
        language: script
        types: [go]
        pass_filenames: false
        description: Prevent commits that drop test coverage below 79% (8min timeout, target 90%)
        stages: [pre-commit]

# Post-commit hooks (run after successful commit)
-   repo: local
    hooks:
    -   id: run-glance
        name: Run glance to update directory overviews
        entry: .pre-commit-hooks/run_glance.sh
        language: script
        stages: [post-commit]
        pass_filenames: false
        always_run: true
